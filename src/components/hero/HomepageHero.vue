<template>
  <div class="homepage-hero">
    <div class="homepage-hero__background">
      <!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
      <svg
        version="1.1"
        id="Capa_1"
        x="0px"
        y="0px"
        viewBox="0 0 512.002 512.002"
      >
        <g>
          <g>
            <path
              fill="#ff9900"
              d="M366.627,228.093c-2.696-4.82-8.787-6.537-13.61-3.842l-0.528,0.299c-4.799,2.734-6.473,8.84-3.74,13.639
			c1.844,3.237,5.221,5.052,8.698,5.052c1.677,0,3.379-0.423,4.94-1.313l0.399-0.225
			C367.605,239.006,369.325,232.912,366.627,228.093z"
            />
          </g>
        </g>
        <g>
          <g>
            <path
              d="M203.07,299.932c-1.859-1.86-4.439-2.93-7.069-2.93s-5.21,1.07-7.07,2.93c-1.861,1.86-2.93,4.44-2.93,7.07
			s1.07,5.21,2.93,7.07s4.44,2.93,7.07,2.93s5.21-1.07,7.069-2.93c1.861-1.86,2.931-4.44,2.931-7.07S204.93,301.792,203.07,299.932z
			"
            />
          </g>
        </g>
        <g>
          <g>
            <path
              d="M258.001,252.002h-24.475c14.316-31.929,23.805-65.657,28.236-100.487l4.159-32.69c0.531-4.175-1.608-8.235-5.352-10.158
			c-3.746-1.924-8.291-1.295-11.374,1.568l-3.346,3.107c-13.921,12.931-26.344,27.097-37.179,42.292
			c8.781-42.155,20.071-84.765,32.344-111.514l0.051-0.111c1.895-4.134,0.761-9.026-2.76-11.905
			c-3.519-2.879-8.538-3.021-12.216-0.345c-19.866,14.461-37.74,31.645-53.065,50.859c2.791-23.629,9.275-46.901,19.188-68.436
			c1.775-3.858,0.921-8.416-2.131-11.369c-3.053-2.952-7.635-3.656-11.434-1.753l-18.491,9.267
			c-28.781,14.423-48.685,40.68-55.092,71.28C91.289,65.755,74.391,52.831,55.261,43.689L28.34,30.822
			c-3.916-1.872-8.6-1.002-11.582,2.156c-2.983,3.158-3.586,7.88-1.492,11.686l1.798,3.269
			c18.441,33.52,32.376,69.065,41.634,106.009c-6.792-5.065-14.081-9.497-21.808-13.19l-22.577-10.79
			c-3.919-1.874-8.601-1.002-11.582,2.157c-2.982,3.158-3.585,7.881-1.49,11.687l1.507,2.74
			c18.198,33.077,31.154,68.513,38.596,105.456H10.001c-5.522,0-10,4.477-10,10v165.5c0,46.594,37.907,84.5,84.5,84.5h99
			c46.594,0,84.5-37.907,84.5-84.5v-165.5C268.001,256.479,263.524,252.002,258.001,252.002z M242.376,145.425l-0.454,3.566
			c-4.562,35.86-14.805,70.481-30.448,103.011h-25.89C195.802,212.227,215.168,175.925,242.376,145.425z M209.122,72.332
			c-16.342,51.649-27.354,116.147-30.872,138.289c-0.009,0.057-0.01,0.114-0.019,0.171c-5.447,13.286-9.876,27.051-13.238,41.211
			H133.16C133.615,184.176,161.413,119.398,209.122,72.332z M122.841,103.165c-0.002-30.034,15.686-57.227,41.305-72.256
			c-8.349,25.12-12.697,51.667-12.697,78.044v2.787c0,0.627,0.065,1.239,0.176,1.834c-3.039,5.109-5.927,10.307-8.623,15.604
			c-2.035,3.998-3.964,8.05-5.797,12.144c-3.424-12.293-8.373-24.154-14.78-35.316C122.692,105.105,122.841,104.152,122.841,103.165
			z M46.634,61.732l0.003,0.002c45.957,21.964,75.76,68.883,76.205,119.762c-6.251,22.956-9.541,46.72-9.689,70.506h-2.073
			c-1.148-22.343-7.975-43.997-19.954-63c-2.008-3.186-4.162-6.261-6.422-9.245C77.324,138.762,64.558,99.177,46.634,61.732z
			 M32.416,160.89c33.92,18.024,56.27,52.856,58.636,91.112H61.734C55.714,220.455,45.891,189.928,32.416,160.89z M248.001,427.502
			c0,35.565-28.935,64.5-64.5,64.5h-99c-35.565,0-64.5-28.934-64.5-64.5v-110.5h137.5c5.522,0,10-4.477,10-10s-4.478-10-10-10
			h-137.5v-25h152.933c0.039,0,0.078,0,0.117,0h44.615c0.011,0,0.023,0.002,0.034,0.002c0.01,0,0.019-0.002,0.028-0.002h30.273
			V427.502z"
            />
          </g>
        </g>
        <g>
          <g>
            <path
              d="M509.87,359.831c-1.896-2.417-4.797-3.829-7.869-3.829h-54.166l-0.002-73.857c0-4.101-0.408-8.182-1.177-12.188
			l36.664-24.685c8.778-5.91,15.42-14.706,18.7-24.765c7.039-21.579-2.229-45.289-22.035-56.377c-0.124-0.069-0.249-0.136-0.376-0.2
			c-16.08-8.123-35.041-6.289-49.166,3.755l-0.001-27.444c0-8.453-2.865-16.778-8.068-23.441
			c-11.159-14.292-31.004-18.73-47.191-10.55c-0.127,0.064-0.253,0.131-0.377,0.201c-15.821,8.86-23.221,27.803-17.596,45.041
			c2.622,8.036,7.929,15.062,14.942,19.782l39.142,26.344c-0.556,2.917-0.851,5.888-0.85,8.873l0.002,16.734
			c-6.372-2.987-13.257-4.957-20.473-5.765c-5.481-0.615-10.437,3.337-11.05,8.826c-0.614,5.489,3.337,10.436,8.825,11.05
			c9.713,1.087,18.579,5.177,25.591,11.686c0.152,0.154,0.314,0.296,0.476,0.439c1.591,1.52,3.084,3.164,4.464,4.931
			c6.16,7.89,9.553,17.747,9.553,27.755l0.003,73.855h-12.387l-55.801-37.556c-8.303-5.588-14.586-13.907-17.692-23.422
			c-3.498-10.719-2.865-22.284,1.783-32.563c2.275-5.032,0.04-10.956-4.992-13.231c-5.033-2.276-10.957-0.041-13.232,4.992
			c-6.709,14.838-7.622,31.532-2.571,47.009c4.483,13.735,13.553,25.742,25.537,33.808l31.149,20.963h-67.628
			c-3.071,0-5.973,1.412-7.868,3.828s-2.575,5.57-1.844,8.553l33.345,136c1.097,4.473,5.106,7.619,9.712,7.619h123.311
			c4.605,0,8.615-3.145,9.712-7.619l33.345-136C512.445,365.401,511.765,362.247,509.87,359.831z M383.321,154.681
			c-3.331-2.242-5.852-5.579-7.097-9.395c-2.649-8.117,0.784-17.03,8.17-21.281c7.651-3.754,16.963-1.626,22.217,5.104
			c2.471,3.165,3.832,7.119,3.832,11.133l0.001,32.695L383.321,154.681z M436.305,189.451c8.063-10.328,22.372-13.573,34.097-7.765
			c11.369,6.48,16.669,20.162,12.605,32.62c-1.905,5.84-5.761,10.945-10.856,14.376l-32.51,21.888
			c-1.639-2.963-3.503-5.807-5.597-8.489c-1.143-1.464-2.351-2.857-3.596-4.204l-0.003-31.391
			C430.444,200.344,432.525,194.295,436.305,189.451z M480.917,410.002H370.334c-5.522,0-10,4.477-10,10s4.478,10,10,10h105.679
			l-15.201,62H353.191l-28.441-116h87.647h25.438h51.418L480.917,410.002z"
            />
          </g>
        </g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
        <g></g>
      </svg>
    </div>
    <div class="numberbar">
      <div class="numberbar-item">
        <div class="numberbar-item__inner">
          <span class="numberbar-item__amount">{{ streakDays }} </span>
          <span class="numberbar-item__description">Current streak (days)</span>
        </div>
      </div>
      <div class="numberbar-item">
        <div class="numberbar-item__inner">
          <span class="numberbar-item__amount" v-if="gratitudes">{{
            gratitudes.length
          }}</span>
          <span class="numberbar-item__description">gratitudes</span>
        </div>
      </div>
      <div class="numberbar-item">
        <div class="numberbar-item__inner">
          <span class="numberbar-item__amount" v-if="gratitudes">{{
            dataObject.length
          }}</span>
          <span class="numberbar-item__description">days of gratitude</span>
        </div>
      </div>
    </div>
  </div>
</template>

<script lang="ts">

// Core
import Vue from 'vue';

// Helpers
import { getDayBefore, isEqualDate } from '@/helpers/dateHelper';
import { getStreak, getGratitudesByDay } from '@/helpers/gratitudeHelper';

// Interfaces
import { IGratitude } from '@/interfaces/gratitude';

export default Vue.extend({
  name: 'HomepageHero',
  props: {
    testvalue: {
      type: String,
      default: ''
    },
    gratitudes: {
      type: Array,
      default: []
    }
  },

  components: {},

  data: () => {
    return {
      streakDays: 0,
      iets: '',
      menuIsOpen: false,
      dataObject: []
    };
  },

  methods: {
    getStreak (data: IGratitude[]) {
      if (!data.length) return;

      const arr = Array.from(getGratitudesByDay(data));
      const today = new Date();

      let startDay = new Date();
      let streak: number = 0;
      let todayHasGratitude = false;
      let yesterdayHasGratitude = false;

      let dayBefore = new Date();
      dayBefore = getDayBefore(dayBefore);

      // First we need to find out if the user has posted today
      // If there is a post today, it should count in the streak
      // If not, we start by checking 'yesterday', because the user
      // might have just opened the app, so 'today' COULD NEVER have a post
      // and the streak would always be zero
      const latest = arr[0] as IGratitude[];
      const latestDate = latest[0] as IGratitude;

      if (isEqualDate(latestDate.dayStamp.toDate(), today)) {
        streak += 1;
        todayHasGratitude = true;
        startDay = today;
      }

      // If the above is not true, check to see if yesterday had any gratitudes,
      // otherwise there is no 'Current streak', so ony continue if one of these is true;

      if (!todayHasGratitude) {
        const yesterday = getDayBefore(today);

        if (isEqualDate(latestDate.dayStamp.toDate(), yesterday)) {
          streak += 1;
          yesterdayHasGratitude = true;
          startDay = yesterday;
        }
      }

      // If both today and yesterday have no Gratitudes, theres not really a streak,
      // so abort. If only today has a Gratitude return only today

      if (!todayHasGratitude && !yesterdayHasGratitude) return streak;
      if (todayHasGratitude && !yesterdayHasGratitude) {
        this.streakDays = 1;
      }

      // Now we know at which point to start counting for you streak
      // Simple check every day 'before', or yesterday, until the quation is false

      // firt reset
      streak = 0;

      let dayToCheck = startDay;

      for (let i = 0; i < 8; i++) {
        let mayContinue = false;

        for (const item of arr) {
          const dayArry = item as IGratitude[];
          const dayEntry = dayArry[0] as IGratitude;
          const found = isEqualDate(dayEntry.dayStamp.toDate(), dayToCheck);

          if (found) streak = streak + 1;
          if (found) mayContinue = true;
        }

        // Finish up, set new day (always yesterday)
        // Update view
        // Check if we can continue
        dayToCheck = getDayBefore(dayToCheck);
        this.streakDays = streak;
        if (!mayContinue) return;
      }
    },

    setTotalDaysOfGratitudes (data: IGratitude[]) {
      this.dataObject = Array.from(getGratitudesByDay(data));
    }
  },

  mounted () {
    if (this.gratitudes.length) {
      this.getStreak(this.gratitudes as IGratitude[]);
      this.setTotalDaysOfGratitudes(this.gratitudes as IGratitude[]);
    }
  },

  watch: {
    gratitudes () {
      this.getStreak(this.gratitudes as IGratitude[]);
      this.setTotalDaysOfGratitudes(this.gratitudes as IGratitude[]);
    }
  }
});
</script>
